# Notes 

* Note: on MPS it's essential to iterate rather than batch, b/c of memory pressure issues. I noticed completely wrong values popping up b/c of swapping (I think). External validation here: https://huggingface.co/docs/diffusers/en/optimization/mps
* CPU/GPU batch/iterate give slightly different results (computational error ~1e-6 abs difference). This is probably related to matrix multiplication issues (i.e., different libraries for cpu vs gpu and different functions for 1D vs ND).
* apparently the batch effect comes for N = 3, i.e.,
```
f([A,]) = [a,]
f([A,A,]) = [a,a,]
f([A,A,A,]) = [b,b,b,]
```


## test sequences
### MS2
>MS2
ASNFTQFVLVDNGGTGDVTVAPSNFANGVAEWISSNSRSQAYKVTCSVRQSSAQKRKYTIKVEVPKVATQTVGGVELPVAAWRSYLNMELTIPIFATNSDCELIVKAMQGLLKDGNPIPSAIAANSGLY

```
ESM: esm2_t33_650M_UR50D
Using Device: mps
----------
WT Sequence: ASNFTQFVLVDNGGTGDVTVAPSNFANGVAEWISSNSRSQAYKVTCSVRQSSAQKRKYTIKVEVPKVATQTVGGVELPVAAWRSYLNMELTIPIFATNSDCELIVKAMQGLLKDGNPIPSAIAANSGLY
WT Perplexity: 47.7915992736816406
Length: 129
Num. Cys: 2
Cys locations: 45 100

---------- Optimization ----------
1. Initial MUT perplexity: 45.31505966
	C45V
	C100A
2.1 Polish, MUT perplexity 48.23052216, 2.458 sec, C45Y
2.2 Polish, MUT perplexity 50.30352020, 2.417 sec, C100I
2.3 Polish, MUT perplexity 50.30352020, 2.453 sec, <no better change>

---------- Final ----------
MUT Sequence: ASNFTQFVLVDNGGTGDVTVAPSNFANGVAEWISSNSRSQAYKVTYSVRQSSAQKRKYTIKVEVPKVATQTVGGVELPVAAWRSYLNMELTIPIFATNSDIELIVKAMQGLLKDGNPIPSAIAANSGLY
MUT Perplexity: 50.30352020
Mutations:
	C45Y
	C100I
```

### RecQ

>recQ
MAQAEVLNLESGAKQVLQETFGYQQFRPGQEEIIDTVLSGRDCLVVMPTGGGKSLCYQIPALLLNGLTVVVSPLISLMKDQVDQLQANGVAAACLNSTQTREQQLEVMTGCRTGQIRLLYIAPERLMLDNFLEHLAHWNPVLLAVDEAHCISQWGHDFRPEYAALGQLRQRFPTLPFMALTATADDTTRQDIVRLLGLNDPLIQISSFDRPNIRYMLMEKFKPLDQLMRYVQEQRGKSGIIYCNSRAKVEDTAARLQSKGISAAAYHAGLENNVRADVQEKFQRDDLQIVVATVAFGMGINKPNVRFVVHFDIPRNIESYYQETGRAGRDGLPAEAMLFYDPADMAWLRRCLEEKPQGQLQDIERHKLNAMGAFAEAQTCRRLVLLNYFGEGRQEPCGNCDICLDPPKQYDGSTDAQIALSTIGRVNQRFGMGYVVEVIRGANNQRIRDYGHDKLKVYGMGRDKSHEHWVSVIRQLIHLGLVTQNIAQHSALQLTEAARPVLRGESSLQLAVPRIVALKPKAMQKSFGGNYDRKLFAKLRKLRKSIADESNVPPYVVFNDATLIEMAEQMPITASEMLSVNGVGMRKLERFGKPFMALIRAHVDGDDEE

```
ESM: esm2_t33_650M_UR50D
Using Device: mps
----------
WT Sequence: MAQAEVLNLESGAKQVLQETFGYQQFRPGQEEIIDTVLSGRDCLVVMPTGGGKSLCYQIPALLLNGLTVVVSPLISLMKDQVDQLQANGVAAACLNSTQTREQQLEVMTGCRTGQIRLLYIAPERLMLDNFLEHLAHWNPVLLAVDEAHCISQWGHDFRPEYAALGQLRQRFPTLPFMALTATADDTTRQDIVRLLGLNDPLIQISSFDRPNIRYMLMEKFKPLDQLMRYVQEQRGKSGIIYCNSRAKVEDTAARLQSKGISAAAYHAGLENNVRADVQEKFQRDDLQIVVATVAFGMGINKPNVRFVVHFDIPRNIESYYQETGRAGRDGLPAEAMLFYDPADMAWLRRCLEEKPQGQLQDIERHKLNAMGAFAEAQTCRRLVLLNYFGEGRQEPCGNCDICLDPPKQYDGSTDAQIALSTIGRVNQRFGMGYVVEVIRGANNQRIRDYGHDKLKVYGMGRDKSHEHWVSVIRQLIHLGLVTQNIAQHSALQLTEAARPVLRGESSLQLAVPRIVALKPKAMQKSFGGNYDRKLFAKLRKLRKSIADESNVPPYVVFNDATLIEMAEQMPITASEMLSVNGVGMRKLERFGKPFMALIRAHVDGDDEE
WT Perplexity: 2003.1860351562500000
Length: 609
Num. Cys: 11
Cys locations: 42 55 93 110 149 242 350 379 396 399 402

---------- Optimization ----------
1. Initial MUT perplexity: 1722.88500977
	C42T
	C55T
	C93M
	C110A
	C149T
	C242V
	C350F
	C379S
	C396H
	C399G
	C402R
2.1 Polish, MUT perplexity 1774.22534180, 74.915 sec, C399Y
2.2 Polish, MUT perplexity 1802.54345703, 74.820 sec, C149P
2.3 Polish, MUT perplexity 1824.06518555, 74.782 sec, C379W
2.4 Polish, MUT perplexity 1851.49792480, 74.808 sec, C402H
2.5 Polish, MUT perplexity 1872.42089844, 74.887 sec, C55P
2.6 Polish, MUT perplexity 1882.78405762, 74.893 sec, C396M
2.7 Polish, MUT perplexity 1892.21813965, 74.818 sec, C93S
2.8 Polish, MUT perplexity 1897.75817871, 74.858 sec, C242P
2.9 Polish, MUT perplexity 1901.93530273, 74.871 sec, C399W
2.10 Polish, MUT perplexity 1906.43713379, 74.858 sec, C402M
2.11 Polish, MUT perplexity 1909.03881836, 74.809 sec, C42A
2.12 Polish, MUT perplexity 1910.34277344, 74.846 sec, C396W
2.13 Polish, MUT perplexity 1911.27758789, 74.823 sec, C110V
2.14 Polish, MUT perplexity 1911.27758789, 74.811 sec, <no better change>

---------- Final ----------
MUT Sequence: MAQAEVLNLESGAKQVLQETFGYQQFRPGQEEIIDTVLSGRDALVVMPTGGGKSLPYQIPALLLNGLTVVVSPLISLMKDQVDQLQANGVAAASLNSTQTREQQLEVMTGVRTGQIRLLYIAPERLMLDNFLEHLAHWNPVLLAVDEAHPISQWGHDFRPEYAALGQLRQRFPTLPFMALTATADDTTRQDIVRLLGLNDPLIQISSFDRPNIRYMLMEKFKPLDQLMRYVQEQRGKSGIIYPNSRAKVEDTAARLQSKGISAAAYHAGLENNVRADVQEKFQRDDLQIVVATVAFGMGINKPNVRFVVHFDIPRNIESYYQETGRAGRDGLPAEAMLFYDPADMAWLRRFLEEKPQGQLQDIERHKLNAMGAFAEAQTWRRLVLLNYFGEGRQEPWGNWDIMLDPPKQYDGSTDAQIALSTIGRVNQRFGMGYVVEVIRGANNQRIRDYGHDKLKVYGMGRDKSHEHWVSVIRQLIHLGLVTQNIAQHSALQLTEAARPVLRGESSLQLAVPRIVALKPKAMQKSFGGNYDRKLFAKLRKLRKSIADESNVPPYVVFNDATLIEMAEQMPITASEMLSVNGVGMRKLERFGKPFMALIRAHVDGDDEE
MUT Perplexity: 1911.27758789
Mutations:
	C42A
	C55P
	C93S
	C110V
	C149P
	C242P
	C350F
	C379W
	C396W
	C399W
	C402M
```

### mRuby3
> mruby3
MSKGEELIKENMRMKVVMEGSVNGHQFKCTGEGEGRPYEGVQVMRIKVIEGGPLPFAFDILATSFMYGSRTFIKYPADIPDFFKQSFPEGFTWERVTRYEDGGVVTVTQDTSLEDGELVYNVKVRGVNFPSNGPVMQKKTKGWEPNTEMMYPADGGLRGYTDIALKVDGGGHLHCNFVTTYRSKKTVGNIKMPGVHAVDHRLERIEESDNETYVVQREVAVAKYSNLGGGMDELYK

```
ESM: esm2_t33_650M_UR50D
Using Device: mps
----------
WT Sequence: MSKGEELIKENMRMKVVMEGSVNGHQFKCTGEGEGRPYEGVQVMRIKVIEGGPLPFAFDILATSFMYGSRTFIKYPADIPDFFKQSFPEGFTWERVTRYEDGGVVTVTQDTSLEDGELVYNVKVRGVNFPSNGPVMQKKTKGWEPNTEMMYPADGGLRGYTDIALKVDGGGHLHCNFVTTYRSKKTVGNIKMPGVHAVDHRLERIEESDNETYVVQREVAVAKYSNLGGGMDELYK
WT Perplexity: 42.6591987609863281
Length: 236
Num. Cys: 2
Cys locations: 28 174

---------- Optimization ----------
1. Initial MUT perplexity: 43.09578323
	C28V
	C174G
2.1 Polish, MUT perplexity 44.55866241, 7.215 sec, C28R
2.2 Polish, MUT perplexity 44.55866241, 4.528 sec, <no better change>

---------- Final ----------
MUT Sequence: MSKGEELIKENMRMKVVMEGSVNGHQFKRTGEGEGRPYEGVQVMRIKVIEGGPLPFAFDILATSFMYGSRTFIKYPADIPDFFKQSFPEGFTWERVTRYEDGGVVTVTQDTSLEDGELVYNVKVRGVNFPSNGPVMQKKTKGWEPNTEMMYPADGGLRGYTDIALKVDGGGHLHGNFVTTYRSKKTVGNIKMPGVHAVDHRLERIEESDNETYVVQREVAVAKYSNLGGGMDELYK
MUT Perplexity: 44.55866241
Mutations:
	C28R
	C174G
```